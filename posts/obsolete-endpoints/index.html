<!doctype html><html lang=en dir=ltr class=scroll-smooth data-default-appearance=dark data-auto-appearance=true><head><meta charset=utf-8><meta http-equiv=content-language content="en"><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><title>Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core &#183; Massimiliano's Tech Chronicles</title>
<meta name=title content="Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core &#183; Massimiliano's Tech Chronicles"><meta name=description content="My adventures in Tech"><meta name=keywords content="dotnet,otel,aspire,"><link rel=canonical href=https://maxdon.tech/posts/obsolete-endpoints/><link type=text/css rel=stylesheet href=/css/main.bundle.min.85f006de1806b55b2d082d1122deedd8cec6fdc1f7c8a51be975a4496165d6c798f4a3de52545a6a87cc4bc09fc2d6f5201d44ea57acc1ac2b1c42a688c62bee.css integrity="sha512-hfAG3hgGtVstCC0RIt7t2M7G/cH3yKUb6XWkSWFl1seY9KPeUlRaaofMS8Cfwtb1IB1E6leswawrHEKmiMYr7g=="><script type=text/javascript src=/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg=="></script><script defer type=text/javascript id=script-bundle src=/js/main.bundle.min.f5c7687e2a3365a5a366307858918deafa574ab869c626f69dcdd5363e26a725991d0efa1aaaff7ba4b7e2472876189d153d2f9b46a39206caf364407e2aaa77.js integrity="sha512-9cdofiozZaWjZjB4WJGN6vpXSrhpxib2nc3VNj4mpyWZHQ76Gqr/e6S34kcodhidFT0vm0ajkgbK82RAfiqqdw==" data-copy data-copied></script><script src=/js/zoom.min.js></script><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta property="og:url" content="https://maxdon.tech/posts/obsolete-endpoints/"><meta property="og:site_name" content="Massimiliano's Tech Chronicles"><meta property="og:title" content="Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core"><meta property="og:description" content="It’s common to evolve HTTP APIs, and while it’s very easy to expose new and improved versions of a given functionality, not so much to safely obsolete and eventually remove an API."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-20T10:16:10+02:00"><meta property="article:modified_time" content="2024-06-20T10:16:10+02:00"><meta property="article:tag" content="Dotnet"><meta property="article:tag" content="Otel"><meta property="article:tag" content="Aspire"><meta property="og:image" content="https://maxdon.tech/posts/obsolete-endpoints/feature.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://maxdon.tech/posts/obsolete-endpoints/feature.webp"><meta name=twitter:title content="Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core"><meta name=twitter:description content="It’s common to evolve HTTP APIs, and while it’s very easy to expose new and improved versions of a given functionality, not so much to safely obsolete and eventually remove an API."><script type=application/ld+json>[{"@context":"https://schema.org","@type":"Article","articleSection":"Posts","name":"Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core","headline":"Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core","abstract":"It\u0026rsquo;s common to evolve HTTP APIs, and while it\u0026rsquo;s very easy to expose new and improved versions of a given functionality, not so much to safely obsolete and eventually remove an API.","inLanguage":"en","url":"https:\/\/maxdon.tech\/posts\/obsolete-endpoints\/","author":{"@type":"Person","name":"Massimiliano Donini"},"copyrightYear":"2024","dateCreated":"2024-06-20T10:16:10\u002b02:00","datePublished":"2024-06-20T10:16:10\u002b02:00","dateModified":"2024-06-20T10:16:10\u002b02:00","keywords":["dotnet","otel","aspire"],"mainEntityOfPage":"true","wordCount":"1613"}]</script><meta name=author content="Massimiliano Donini"><link href=https://github.com/ilmax rel=me><link href=https://www.linkedin.com/in/massimiliano-donini/ rel=me><link href=https://x.com/maxx_don rel=me><script src=/lib/jquery/jquery.slim.min.js integrity></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-QK96EXLDNF"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QK96EXLDNF")</script><meta name=theme-color></head><body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32 scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600"><div id=the-top class="absolute flex self-center"><a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href=#main-content><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">&darr;</span>Skip to main content</a></div><div class=min-h-[148px]></div><div class="fixed inset-x-0 pl-[24px] pr-[24px]" style=z-index:100><div id=menu-blur class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl"></div><div class="relative max-w-[64rem] ml-auto mr-auto"><div style=padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3"><div class="flex flex-1 items-center justify-between"><nav class="flex space-x-3"><a href=/ class="text-base font-medium text-gray-500 hover:text-gray-900">Massimiliano&rsquo;s Tech Chronicles</a></nav><nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12"><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>About</p></a><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title>Posts</p></a><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><span class=mr-1><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M48 32H197.5c17 0 33.2 6.74 45.2 18.75l176 175.95c25 25 25 65.6.0 90.6L285.3 450.7c-25 25-65.6 25-90.6.0L18.75 274.7C6.743 262.7.0 246.5.0 229.5V80C0 53.49 21.49 32 48 32zm64 144c17.7.0 32-14.3 32-32 0-17.7-14.3-32-32-32-17.67.0-32 14.3-32 32s14.33 32 32 32z"/></svg></span></span><p class="text-base font-medium" title>Tags</p></a><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-base font-medium" title></p></a><button id=search-button aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></button><div class="ltr:mr-14 rtl:ml-14 flex items-center"><button id=appearance-switcher aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400"><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></nav><div class="flex md:hidden items-center space-x-5 md:ml-12 h-12"><span></span>
<button id=search-button-mobile aria-label=Search class="text-base hover:text-primary-600 dark:hover:text-primary-400" title>
<span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg>
</span></button>
<button id=appearance-switcher-mobile aria-label="Dark mode switcher" type=button class="text-base hover:text-primary-600 dark:hover:text-primary-400" style=margin-right:5px><div class="flex items-center justify-center dark:hidden"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M32 256C32 132.2 132.3 32 255.8 32c11.36.0 29.7 1.668 40.9 3.746 9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3 9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480 132.1 480 32 379.6 32 256z"/></svg></span></div><div class="items-center justify-center hidden dark:flex"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 159.1c-53.02.0-95.1 42.98-95.1 95.1s41.2 96.9 95.1 96.9 95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347l-63.2-91.9 63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89 164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6 12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256 2.74 347.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7 19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109 109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69.0-127.1-57.31-127.1-127.1.0-70.69 57.31-127.1 127.1-127.1S383.1 186.2 383.1 256c0 70.7-56.4 127.1-127.1 127.1z"/></svg></span></div></button></div></div><div class="-my-2 -mr-2 md:hidden"><label id=menu-button for=menu-controller class=block><input type=checkbox id=menu-controller class=hidden><div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M0 96C0 78.33 14.33 64 32 64H416c17.7.0 32 14.33 32 32 0 17.7-14.3 32-32 32H32C14.33 128 0 113.7.0 96zM0 256c0-17.7 14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32H32c-17.67.0-32-14.3-32-32zM416 448H32c-17.67.0-32-14.3-32-32s14.33-32 32-32H416c17.7.0 32 14.3 32 32s-14.3 32-32 32z"/></svg></span></div><div id=menu-wrapper style=padding-top:5px class="fixed inset-0 z-30 invisible w-screen h-screen m-0 overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50"><ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl"><li><span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></span></li><li class=mt-1><a href=/about/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>About</p></a></li><li class=mt-1><a href=/posts/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title>Posts</p></a></li><li class=mt-1><a href=/tags/ class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><div class=mr-2><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M48 32H197.5c17 0 33.2 6.74 45.2 18.75l176 175.95c25 25 25 65.6.0 90.6L285.3 450.7c-25 25-65.6 25-90.6.0L18.75 274.7C6.743 262.7.0 246.5.0 229.5V80C0 53.49 21.49 32 48 32zm64 144c17.7.0 32-14.3 32-32 0-17.7-14.3-32-32-32-17.67.0-32 14.3-32 32s14.33 32 32 32z"/></svg></span></div><p class="text-bg font-bg" title>Tags</p></a></li><li class=mt-1><a href class="flex items-center text-gray-500 hover:text-primary-600 dark:hover:text-primary-400"><p class="text-bg font-bg" title></p></a></li></ul></div></label></div></div><script>(function(){var e=$(".main-menu"),t=window.location.pathname;e.find('a[href="'+t+'"]').each(function(e,t){$(t).children("p").addClass("active")})})()</script></div></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("menu-blur");n.style.opacity=t/300})</script><div class="relative flex flex-col grow"><main id=main-content class=grow><article><div id=hero class="h-[150px] md:h-[200px]"></div><div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style=background-image:url(/posts/obsolete-endpoints/feature_huf1a1a748b211d987700874d0a5666430_128398_1200x0_resize_q75_h2_box_2.webp)><div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal"></div><div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal"></div></div><div id=background-blur class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl"></div><script>window.addEventListener("scroll",function(){var t=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,n=document.getElementById("background-blur");n.style.opacity=t/300})</script><header id=single_header class="mt-5 max-w-prose"><h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">Telemetry-Driven API Evolution: Removing Obsolete Endpoints in ASP.NET Core</h1><div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden"><div class="flex flex-row flex-wrap items-center"><time datetime="2024-06-20 10:16:10 +0200 +0200">20 June 2024</time><span class="px-2 text-primary-500">&#183;</span><span title="Reading time">8 mins</span><span class="px-2 text-primary-500">&#183;</span>
<script type=text/javascript src=/js/zen-mode.min.63c8a202661f4a2063fdc2706685d668e8ea3da613da2224e9da527e5876e4f53dcac39ab60732626fb4151feae5d430d0cf44731e5d3c726522fcc1519c1547.js integrity="sha512-Y8iiAmYfSiBj/cJwZoXWaOjqPaYT2iIk6dpSflh25PU9ysOatgcyYm+0FR/q5dQw0M9Ecx5dPHJlIvzBUZwVRw=="></script><span class=mb-[2px]><span id=zen-mode-button class="text-lg hover:text-primary-500" title="Enable zen mode" data-title-i18n-disable="Enable zen mode" data-title-i18n-enable="Disable zen mode"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 50 50" width="50" height="50"><path fill="currentcolor" d="M12.980469 4C9.1204688 4 5.9804688 7.14 5.9804688 11L6 26H9.9804688V11c0-1.65 1.3400002-3 3.0000002-3H40.019531c1.66.0 3 1.35 3 3V39c0 1.65-1.34 3-3 3H29c0 1.54-.579062 2.94-1.539062 4H40.019531c3.86.0 7-3.14 7-7V11c0-3.86-3.14-7-7-7H12.980469zM7 28c-2.206.0-4 1.794-4 4V42c0 2.206 1.794 4 4 4H23c2.206.0 4-1.794 4-4V32c0-2.206-1.794-4-4-4H7zm0 4H23L23.001953 42H7V32z"/></svg></span></span></span></span></div><div class="flex flex-row flex-wrap items-center"><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/dotnet/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Dotnet
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/otel/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Otel
</span></span></span><span style=margin-top:.5rem class=mr-2 onclick='window.open("/tags/aspire/","_self")'><span class=flex style=cursor:pointer><span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">Aspire</span></span></span></div></div><div class="flex author"><img class="!mt-0 !mb-0 h-24 w-24 rounded-full ltr:mr-4 rtl:ml-4" width=96 height=96 alt="Massimiliano Donini" src=/avatar_hu64302a0889d56f5fdb5f64e15171f4b7_94191_192x192_fill_q75_box_center.jpg><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Author</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">Massimiliano Donini</div><div class="text-sm text-neutral-700 dark:text-neutral-400">🔭 I’m currently working as a freelance Cloud Architect in The Netherlands 🇳🇱 I’m looking to collaborate on Azure and the dotnet technology landscape 💬 Ask me about Azure, dotnet, EF Core, ASP.NET Core, terraform, GitHub & CI/CD automation</div><div class="text-2xl sm:text-lg"><div class="flex flex-wrap text-neutral-400 dark:text-neutral-500"><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://github.com/ilmax target=_blank aria-label=Github rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://www.linkedin.com/in/massimiliano-donini/ target=_blank aria-label=Linkedin rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></span></a><a class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href=https://x.com/maxx_don target=_blank aria-label=X-Twitter rel="me noopener noreferrer"><span class="inline-block align-text-bottom"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg></span></span></a></div></div></div></div><div class=mb-5></div></header><section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row"><div class="order-first lg:ml-auto px-0 lg:order-last ltr:lg:pl-8 rtl:lg:pr-8"><div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-[140px]"><details open id=TOCView class="toc-right mt-0 overflow-y-scroll overscroll-contain scrollbar-thin scrollbar-track-neutral-200 scrollbar-thumb-neutral-400 dark:scrollbar-track-neutral-800 dark:scrollbar-thumb-neutral-600 rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block"><summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="min-w-[220px] py-2 border-dotted ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#marking-endpoints-as-obsolete>Marking endpoints as obsolete</a></li><li><a href=#intercepting-endpoint-invocations>Intercepting endpoint invocations</a></li><li><a href=#emitting-custom-telemetry-using-an-aspnet-core-filter>Emitting custom telemetry using an ASP.NET Core filter</a></li><li><a href=#registering-the-filter>Registering the filter</a></li><li><a href=#visualize-the-telemetry-in-the-aspire-dashboard>Visualize the telemetry in the Aspire Dashboard</a></li><li><a href=#references>References</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></details><details class="toc-inside mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden"><summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">Table of Contents</summary><div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600"><nav id=TableOfContents><ul><li><a href=#marking-endpoints-as-obsolete>Marking endpoints as obsolete</a></li><li><a href=#intercepting-endpoint-invocations>Intercepting endpoint invocations</a></li><li><a href=#emitting-custom-telemetry-using-an-aspnet-core-filter>Emitting custom telemetry using an ASP.NET Core filter</a></li><li><a href=#registering-the-filter>Registering the filter</a></li><li><a href=#visualize-the-telemetry-in-the-aspire-dashboard>Visualize the telemetry in the Aspire Dashboard</a></li><li><a href=#references>References</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></details><script>var margin=200,marginError=50;(function(){var t=$(window),e=$("#TOCView"),s=e.height();function n(){var n=t.height()-margin;s>=n?(e.css("overflow-y","scroll"),e.css("max-height",n+marginError+"px")):(e.css("overflow-y","hidden"),e.css("max-height","9999999px"))}t.on("resize",n),$(document).ready(n)})(),function(){var t,e=$("#TableOfContents");if(e.length>0){t=$(window);function n(){var s,o=t.scrollTop(),i=$(".anchor"),n="";if(i.each(function(e,t){t=$(t),t.offset().top-$(window).height()/3<=o&&(n=decodeURIComponent(t.attr("id")))}),s=e.find("a.active"),s.length==1&&s.eq(0).attr("href")=="#"+n)return!0;s.each(function(e,t){$(t).removeClass("active")}),e.find('a[href="#'+n+'"]').addClass("active"),e.find('a[href="#'+n+'"]').parentsUntil("#TableOfContents").each(function(e,t){$(t).children("a").parents("ul").show()})}t.on("scroll",n),$(document).ready(function(){n()})}}()</script></div></div><div class="min-w-0 min-h-0 max-w-fit"><div class="article-content max-w-prose mb-20"><p>It&rsquo;s common to evolve HTTP APIs, and while it&rsquo;s very easy to expose new and improved versions of a given functionality, not so much to safely obsolete and eventually remove an API.</p><p>Have you ever deprecated endpoints and wanted to clean them up after some time? Have you ever deleted obsolete endpoints only to discover, after the deployment that some forgotten service was still using those endpoints? Have you ever needed to track the usage of those obsolete endpoints to plot a nice roadmap toward safe deletion?</p><p>If those questions resonate with you, please follow along, I will show you how to use <a href=https://opentelemetry.io/ target=_blank>OpenTelemetry</a> to track usage metrics and <a href=https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview target=_blank>Aspire</a> to visualize those metrics.
As we all know, APIs tend to evolve and managing API versioning is a tricky business. More often than not we need to live with multiple versions of an API just because we are not sure if you can delete the older version of the API and you choose the &ldquo;better safe than sorry&rdquo; way of dealing with the problem.</p><h2 class="relative group">Marking endpoints as obsolete<div id=marking-endpoints-as-obsolete class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#marking-endpoints-as-obsolete aria-label=Anchor>#</a></span></h2><p>In ASP.NET Core there&rsquo;s no first-class support for obsoleting endpoints. To do so we can add some metadata to endpoints we want to obsolete and emit some metric every time an endpoint with our newly added metadata executes.</p><p>To add metadata to endpoints we use C# attributess. You can implement your custom attribute or, preferably, use the built-in <code>[ObsoleteAttribute]</code> that will mark the endpoint as deprecated and will also reflect in the Swagger UI as shown below (<em>See the grey color and the strikethrough name)</em>:</p><p><figure><img class="my-0 rounded-md" loading=lazy srcset="/posts/obsolete-endpoints/images/swagger-ui-obsolete-endpoints-min_hu0fbfbc37505ca5629d91753813716ba7_32078_330x0_resize_box_3.png 330w,
/posts/obsolete-endpoints/images/swagger-ui-obsolete-endpoints-min_hu0fbfbc37505ca5629d91753813716ba7_32078_660x0_resize_box_3.png 660w,
/posts/obsolete-endpoints/images/swagger-ui-obsolete-endpoints-min_hu0fbfbc37505ca5629d91753813716ba7_32078_1024x0_resize_box_3.png 1024w,
/posts/obsolete-endpoints/images/swagger-ui-obsolete-endpoints-min_hu0fbfbc37505ca5629d91753813716ba7_32078_1320x0_resize_box_3.png 2x" src=/posts/obsolete-endpoints/images/swagger-ui-obsolete-endpoints-min_hu0fbfbc37505ca5629d91753813716ba7_32078_660x0_resize_box_3.png alt="Swagger UI obsolete endpoints"><figcaption>Swagger UI obsolete endpoints</figcaption></figure></p><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Please note that if you use <code>WithOpenApi()</code> on a minimal API, it doesn&rsquo;t show the endpoint as obsolete in the UI, refer to the <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/openapi?view=aspnetcore-8.0" target=_blank>documentation</a> to correctly setup OpenApi in Minimal API</span></div><p>For controllers, you can add the <code>[Obsolete]</code> attribute to either a specific controller action or the entire controller, as shown below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=na>[Tags(&#34;Controller&#34;)]</span>
</span></span><span class=line><span class=cl><span class=na>[Route(&#34;api/[controller]</span><span class=s>&#34;)]
</span></span></span><span class=line><span class=cl><span class=s></span><span class=kd>public</span> <span class=k>class</span> <span class=nc>WeatherController</span> <span class=p>:</span> <span class=n>ControllerBase</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>    [HttpGet]</span>
</span></span><span class=line><span class=cl><span class=na>    [Obsolete]</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=n>IActionResult</span> <span class=n>GetWeather</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>Ok</span><span class=p>(</span><span class=n>WeatherGenerator</span><span class=p>.</span><span class=n>Generate</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Adding the attribute at the controller level marks all the controller actions (HTTP APIs) as obsolete while adding to the action marks a single action.</p><p>If you&rsquo;re using Minimal API instead, you can achieve the same effect using the following code</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>MapGet</span><span class=p>(</span><span class=s>&#34;/weatherforecast&#34;</span><span class=p>,</span> <span class=p>[</span><span class=n>Obsolete</span><span class=p>]()</span> <span class=p>=&gt;</span> <span class=n>WeatherGenerator</span><span class=p>.</span><span class=n>Generate</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>WithTags</span><span class=p>(</span><span class=s>&#34;MinimalApi&#34;</span><span class=p>);</span>
</span></span></code></pre></div><blockquote><p>Minimal API is a simplified approach for building HTTP APIs in ASP.NET Core. For more details, refer to the official <a href="https://learn.microsoft.com/en-us/aspnet/core/fundamentals/minimal-apis/overview?view=aspnetcore-8.0" target=_blank>documentation</a></p></blockquote><p>Adding the <code>[Obsolete]</code> attribute though, is only adding some metadata to the endpoint that will reflect in the OpenApi definition and the Swagger UI, so we need to manually emit some custom telemetry ourselves and follow along to discover how to do it.</p><h2 class="relative group">Intercepting endpoint invocations<div id=intercepting-endpoint-invocations class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#intercepting-endpoint-invocations aria-label=Anchor>#</a></span></h2><p>Once endpoints are marked as obsolete, we need to emit custom telemetry every time our endpoints are invoked. In the MVC world (i.e. when we build our API using controllers) we can implement a filter.</p><p><a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-8.0" target=_blank>Filters</a> in MVC are a very powerful way of executing custom code in various stages of the HTTP request pipeline.</p><p><figure class="flex items-center justify-center"><img src=/posts/obsolete-endpoints/images/mvc-filters-min.png alt=images/mvc-filters-min.png></figure><em>Image courtesy of <a href="https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-8.0" target=_blank>https://learn.microsoft.com/en-us/aspnet/core/mvc/controllers/filters?view=aspnetcore-8.0</a></em></p><p>As you can see from the image above, the best option is to implement an ActionFilter that runs just before and after our controller action. The code is quite straightforward, we check if our action (the method in the controller that implements the HTTP API) has the obsolete attribute and we emit some telemetry as shown below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ObsoleteActionFilter</span> <span class=p>:</span> <span class=n>IAsyncActionFilter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>async</span> <span class=n>Task</span> <span class=n>OnActionExecutionAsync</span><span class=p>(</span><span class=n>ActionExecutingContext</span> <span class=n>context</span><span class=p>,</span> <span class=n>ActionExecutionDelegate</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>obsoleteAttribute</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>ActionDescriptor</span><span class=p>.</span><span class=n>EndpointMetadata</span><span class=p>.</span><span class=n>OfType</span><span class=p>&lt;</span><span class=n>ObsoleteAttribute</span><span class=p>&gt;().</span><span class=n>FirstOrDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>obsoleteAttribute</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Emit custom telemetry</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>next</span><span class=p>();</span>    
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>For Minimal API we have to implement something similar, but we can&rsquo;t reuse the same code, we have to instead craft a filter specifically for Minimal API like the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ObsoleteEndpointFilter</span> <span class=p>:</span> <span class=n>IEndpointFilter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>async</span> <span class=n>ValueTask</span><span class=p>&lt;</span><span class=kt>object?</span><span class=p>&gt;</span> <span class=n>InvokeAsync</span><span class=p>(</span><span class=n>EndpointFilterInvocationContext</span> <span class=n>context</span><span class=p>,</span> <span class=n>EndpointFilterDelegate</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>endpoint</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>GetEndpoint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>endpoint</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>obsolete</span> <span class=p>=</span> <span class=n>endpoint</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>OfType</span><span class=p>&lt;</span><span class=n>ObsoleteAttribute</span><span class=p>&gt;().</span><span class=n>FirstOrDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>obsolete</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Emit custom telemetry</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>next</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>next</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 class="relative group">Emitting custom telemetry using an ASP.NET Core filter<div id=emitting-custom-telemetry-using-an-aspnet-core-filter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#emitting-custom-telemetry-using-an-aspnet-core-filter aria-label=Anchor>#</a></span></h2><p>Now that the skeleton of our filters is done, we have to emit custom telemetry to signal that an obsolete endpoint has been invoked.</p><p>OpenTelemetry allows us to emit <a href=https://opentelemetry.io/docs/concepts/signals/metrics/ target=_blank>metric signals</a>, in dotnet to emit custom telemetry we need to create a <code>Meter</code> and from it an instrument. In our case, the <code>Counter&lt;T></code> is the most appropriate instrument to record endpoint invocations.</p><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Showing how to best use OpenTelemetry is outside of the scope of this article, but if you&rsquo;re interested there&rsquo;s a great and very pragmatic <a href="https://www.youtube.com/watch?v=WzZI_IT6gYo&amp;ab_channel=NDCConferences" target=_blank>YoutTube video</a> on how to do telemetry in dotnet by <a href=https://x.com/MartinDotNet target=_blank>Martin Thwaites</a> that can get you up to speed quickly.</span></div><p>Please note that the <code>Meter</code> class needs to be a singleton and you should configure OpenTelemetry to listen to the specific meter using the same name to get telemetry emitted. Don&rsquo;t worry if this sounds a bit convoluted now, especially if you&rsquo;re not so familiar with how OpenTelemetry works in dotnet. Martin does an excellent job in getting you up to speed quickly, moreover you can also find all the source code for this article in my GitHub repository
<a id=github-2a2fab3b676e26199df6726362c0d524 target=_blank href=https://github.com/ilmax/obsolete-endpoints class=cursor-pointer><div class="w-full md:w-auto pt-3 p-5 border border-neutral-200 dark:border-neutral-700 border rounded-md shadow-2xl"><div class="flex items-center"><span class="text-2xl text-neutral-800 dark:text-neutral" style=margin-right:10px><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path fill="currentcolor" d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6.0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6.0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3.0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1.0-6.2-.3-40.4-.3-61.4.0.0-70 15-84.7-29.8.0.0-11.4-29.1-27.8-36.6.0.0-22.9-15.7 1.6-15.4.0.0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5.0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9.0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4.0 33.7-.3 75.4-.3 83.6.0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6.0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9.0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span></span><div id=github-2a2fab3b676e26199df6726362c0d524-full_name class="m-0 font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral">ilmax/obsolete-endpoints</div></div><p id=github-2a2fab3b676e26199df6726362c0d524-description class="m-0 mt-2 text-md text-neutral-800 dark:text-neutral">Sample code for the obsolete endpoint blog post</p><div class="m-0 mt-2 flex items-center"><span class="mr-1 inline-block h-3 w-3 rounded-full" style=background-color:#178600></span><div class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">C#</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path fill="currentcolor" d="M287.9.0C297.1.0 305.5 5.25 309.5 13.52L378.1 154.8l153.3 22.7C540.4 178.8 547.8 185.1 550.7 193.7 553.5 202.4 551.2 211.9 544.8 218.2L433.6 328.4l26.3 155.5C461.4 492.9 457.7 502.1 450.2 507.4 442.8 512.7 432.1 513.4 424.9 509.1L287.9 435.9 150.1 509.1C142.9 513.4 133.1 512.7 125.6 507.4 118.2 502.1 114.5 492.9 115.1 483.9l27.1-155.5L31.11 218.2C24.65 211.9 22.36 202.4 25.2 193.7 28.03 185.1 35.5 178.8 44.49 177.5L197.7 154.8 266.3 13.52C270.4 5.249 278.7.0 287.9.0zm0 78.95L235.4 187.2C231.9 194.3 225.1 199.3 217.3 200.5L98.98 217.9 184.9 303C190.4 308.5 192.9 316.4 191.6 324.1L171.4 443.7l105.2-56.2C283.7 383.7 292.2 383.7 299.2 387.5l105.2 56.2-20.2-119.6C382.9 316.4 385.5 308.5 391 303l85.9-85.1-118.3-17.4C350.7 199.3 343.9 194.3 340.5 187.2L287.9 78.95z"/></svg></span></span><div id=github-2a2fab3b676e26199df6726362c0d524-stargazers class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div><span class="text-md mr-1 text-neutral-800 dark:text-neutral"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M80 104c13.3.0 24-10.7 24-24S93.3 56 80 56 56 66.7 56 80s10.7 24 24 24zm80-24c0 32.8-19.7 61-48 73.3V192c0 17.7 14.3 32 32 32H304c17.7.0 32-14.3 32-32V153.3C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3V192c0 53-43 96-96 96H256v70.7c28.3 12.3 48 40.5 48 73.3.0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3V288H144c-53 0-96-43-96-96V153.3C19.7 141 0 112.8.0 80 0 35.8 35.8.0 80 0s80 35.8 80 80zm208 24c13.3.0 24-10.7 24-24s-10.7-24-24-24-24 10.7-24 24 10.7 24 24 24zM248 432c0-13.3-10.7-24-24-24s-24 10.7-24 24 10.7 24 24 24 24-10.7 24-24z"/></svg></span></span><div id=github-2a2fab3b676e26199df6726362c0d524-forks class="m-0 mr-5 text-md text-neutral-800 dark:text-neutral">0</div></div></div><script>fetch("https://api.github.com/repos/ilmax/obsolete-endpoints",{headers:new Headers({"User-agent":"Mozilla/4.0 Custom User Agent"})}).then(e=>e.json()).then(e=>{document.getElementById("github-2a2fab3b676e26199df6726362c0d524-full_name").innerHTML=e.full_name,document.getElementById("github-2a2fab3b676e26199df6726362c0d524-description").innerHTML=e.description,document.getElementById("github-2a2fab3b676e26199df6726362c0d524-stargazers").innerHTML=e.stargazers_count,document.getElementById("github-2a2fab3b676e26199df6726362c0d524-forks").innerHTML=e.forks}).catch(e=>console.error(e))</script></a></p><p>So without further ado, here&rsquo;s the OpentTelementry code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=c1>// Service level configuration</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>DiagnosticConfig</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>const</span> <span class=kt>string</span> <span class=n>ServiceName</span> <span class=p>=</span> <span class=s>&#34;ObsoleteEndpointsService&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=n>Meter</span> <span class=n>Meter</span> <span class=p>=</span> <span class=k>new</span><span class=p>(</span><span class=n>ServiceName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>readonly</span> <span class=n>Counter</span><span class=p>&lt;</span><span class=kt>long</span><span class=p>&gt;</span> <span class=n>ObsoleteEndpointCounter</span> <span class=p>=</span> <span class=n>Meter</span><span class=p>.</span><span class=n>CreateCounter</span><span class=p>&lt;</span><span class=kt>long</span><span class=p>&gt;(</span><span class=s>&#34;ObsoleteInvocationCount&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>DiagnosticNames</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>const</span> <span class=kt>string</span> <span class=n>Url</span> <span class=p>=</span> <span class=n>nameof</span><span class=p>(</span><span class=n>Url</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>const</span> <span class=kt>string</span> <span class=n>DisplayName</span> <span class=p>=</span> <span class=n>nameof</span><span class=p>(</span><span class=n>DisplayName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>const</span> <span class=kt>string</span> <span class=n>ObsoleteEndpoint</span> <span class=p>=</span> <span class=n>nameof</span><span class=p>(</span><span class=n>ObsoleteEndpoint</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Action Filter (MVC)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ObsoleteActionFilter</span> <span class=p>:</span> <span class=n>IAsyncActionFilter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>async</span> <span class=n>Task</span> <span class=n>OnActionExecutionAsync</span><span class=p>(</span><span class=n>ActionExecutingContext</span> <span class=n>context</span><span class=p>,</span> <span class=n>ActionExecutionDelegate</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>obsoleteAttribute</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>ActionDescriptor</span><span class=p>.</span><span class=n>EndpointMetadata</span><span class=p>.</span><span class=n>OfType</span><span class=p>&lt;</span><span class=n>ObsoleteAttribute</span><span class=p>&gt;().</span><span class=n>FirstOrDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>obsoleteAttribute</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// Enrich current span</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>activity</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>Features</span><span class=p>.</span><span class=n>Get</span><span class=p>&lt;</span><span class=n>IHttpActivityFeature</span><span class=p>&gt;()?.</span><span class=n>Activity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=n>activity</span><span class=p>.</span><span class=n>EnrichWithActionContext</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1>// Emit custom metric</span>
</span></span><span class=line><span class=cl>            <span class=n>DiagnosticConfig</span><span class=p>.</span><span class=n>ObsoleteEndpointCounter</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=k>new</span> <span class=n>KeyValuePair</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object?</span><span class=p>&gt;(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>,</span> <span class=n>context</span><span class=p>.</span><span class=n>ActionDescriptor</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>next</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>await</span> <span class=n>next</span><span class=p>();</span>    
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// Endpoint Filter (Minimal API)</span>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=k>class</span> <span class=nc>ObsoleteEndpointFilter</span> <span class=p>:</span> <span class=n>IEndpointFilter</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>async</span> <span class=n>ValueTask</span><span class=p>&lt;</span><span class=kt>object?</span><span class=p>&gt;</span> <span class=n>InvokeAsync</span><span class=p>(</span><span class=n>EndpointFilterInvocationContext</span> <span class=n>context</span><span class=p>,</span> <span class=n>EndpointFilterDelegate</span> <span class=n>next</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=kt>var</span> <span class=n>endpoint</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>GetEndpoint</span><span class=p>();</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>endpoint</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=kt>var</span> <span class=n>obsoleteAttribute</span> <span class=p>=</span> <span class=n>endpoint</span><span class=p>.</span><span class=n>Metadata</span><span class=p>.</span><span class=n>OfType</span><span class=p>&lt;</span><span class=n>ObsoleteAttribute</span><span class=p>&gt;().</span><span class=n>FirstOrDefault</span><span class=p>();</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>obsoleteAttribute</span> <span class=k>is</span> <span class=n>not</span> <span class=kc>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// Enrich current span</span>
</span></span><span class=line><span class=cl>                <span class=kt>var</span> <span class=n>activity</span> <span class=p>=</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>Features</span><span class=p>.</span><span class=n>Get</span><span class=p>&lt;</span><span class=n>IHttpActivityFeature</span><span class=p>&gt;()?.</span><span class=n>Activity</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>activity</span><span class=p>.</span><span class=n>EnrichWithEndpoint</span><span class=p>(</span><span class=n>endpoint</span><span class=p>,</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=c1>// Emit custom metric</span>
</span></span><span class=line><span class=cl>                <span class=n>DiagnosticConfig</span><span class=p>.</span><span class=n>ObsoleteEndpointCounter</span><span class=p>.</span><span class=n>Add</span><span class=p>(</span><span class=m>1</span><span class=p>,</span> <span class=k>new</span> <span class=n>KeyValuePair</span><span class=p>&lt;</span><span class=kt>string</span><span class=p>,</span> <span class=kt>object?</span><span class=p>&gt;(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>));</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=k>await</span> <span class=n>next</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=k>await</span> <span class=n>next</span><span class=p>(</span><span class=n>context</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><em>A special thank you to <a href=https://x.com/MartinDotNet target=_blank>Martin Thwaites</a> for reviewing and suggesting how to improve the OTel emitting code.</em></p><h2 class="relative group">Registering the filter<div id=registering-the-filter class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#registering-the-filter aria-label=Anchor>#</a></span></h2><p>Now that we created the filter(s), we need to make sure ASP.NET Core executes our filters during the HTTP Require pipeline, we achieve this by registering the filter(s). MVC and Minimal API have two different ways of registering a filter, in MVC you can do it in several ways, but if you want to apply the filter globally (so that it runs for every HTTP request), you can do the following:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>builder</span><span class=p>.</span><span class=n>Services</span><span class=p>.</span><span class=n>AddControllers</span><span class=p>(</span><span class=n>opt</span> <span class=p>=&gt;</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>opt</span><span class=p>.</span><span class=n>Filters</span><span class=p>.</span><span class=n>Add</span><span class=p>&lt;</span><span class=n>ObsoleteActionFilter</span><span class=p>&gt;();</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>Whilst in Minimal API there&rsquo;s no easy way to register a global endpoint filter so in my case I&rsquo;m adding it to the single endpoint in this way:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=n>app</span><span class=p>.</span><span class=n>MapGet</span><span class=p>(</span><span class=s>&#34;/weatherforecast&#34;</span><span class=p>,</span> <span class=p>[</span><span class=n>Obsolete</span><span class=p>]()</span> <span class=p>=&gt;</span> <span class=n>WeatherGenerator</span><span class=p>.</span><span class=n>Generate</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>AddEndpointFilter</span><span class=p>&lt;</span><span class=n>ObsoleteEndpointFilter</span><span class=p>&gt;()</span> <span class=c1>// &lt;-- Filter added here</span>
</span></span><span class=line><span class=cl>    <span class=p>.</span><span class=n>WithTags</span><span class=p>(</span><span class=s>&#34;MinimalApi&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>there are some clever tricks you can do to register a filter globally, <a href=https://github.com/khalidabuhakmeh target=_blank>Khalid Abuhakmeh</a> has written a nice post about it, you if you&rsquo;re interested you can find more <a href=https://khalidabuhakmeh.com/global-endpoint-filters-with-aspnet-core-minimal-apis target=_blank>here</a></p><h2 class="relative group">Visualize the telemetry in the Aspire Dashboard<div id=visualize-the-telemetry-in-the-aspire-dashboard class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#visualize-the-telemetry-in-the-aspire-dashboard aria-label=Anchor>#</a></span></h2><p>Our custom metrics telemetry gets exported to the Aspire Dashboard via the OLTP protocol and then shown as follows:<figure><img class="my-0 rounded-md" loading=lazy srcset="/posts/obsolete-endpoints/images/metrics-min_hu4904e62bc15f10e10fef75f307357cb6_27353_330x0_resize_box_3.png 330w,
/posts/obsolete-endpoints/images/metrics-min_hu4904e62bc15f10e10fef75f307357cb6_27353_660x0_resize_box_3.png 660w,
/posts/obsolete-endpoints/images/metrics-min_hu4904e62bc15f10e10fef75f307357cb6_27353_1024x0_resize_box_3.png 1024w,
/posts/obsolete-endpoints/images/metrics-min_hu4904e62bc15f10e10fef75f307357cb6_27353_1320x0_resize_box_3.png 2x" src=/posts/obsolete-endpoints/images/metrics-min_hu4904e62bc15f10e10fef75f307357cb6_27353_660x0_resize_box_3.png alt="Obsolete metrics"><figcaption>Obsolete metrics</figcaption></figure></p><p>As you can see I&rsquo;m not adding many additional tags here, I&rsquo;m just adding the display name that ASP.NET Core computes for the action/endpoint. This should be enough information to identify the called endpoint, but maybe you need some more information about the caller, to accomplish this I decided to also emit a custom span that I then enrich with the <code>ActionExecutingContext</code>/<code>EndpointFilterInvocationContext</code> with the following code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-csharp data-lang=csharp><span class=line><span class=cl><span class=kd>public</span> <span class=kd>static</span> <span class=k>class</span> <span class=nc>ActivityExtensions</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>EnrichWithEndpoint</span><span class=p>(</span><span class=k>this</span> <span class=n>Activity</span><span class=p>?</span> <span class=n>activity</span><span class=p>,</span> <span class=n>Endpoint</span> <span class=n>endpoint</span><span class=p>,</span> <span class=n>HttpContext</span> <span class=n>httpContext</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>Url</span><span class=p>,</span> <span class=n>httpContext</span><span class=p>.</span><span class=n>Request</span><span class=p>.</span><span class=n>GetDisplayUrl</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>,</span> <span class=n>endpoint</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>ObsoleteEndpoint</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=k>void</span> <span class=n>EnrichWithActionContext</span><span class=p>(</span><span class=k>this</span> <span class=n>Activity</span><span class=p>?</span> <span class=n>activity</span><span class=p>,</span> <span class=n>ActionExecutingContext</span> <span class=n>context</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>Url</span><span class=p>,</span> <span class=n>context</span><span class=p>.</span><span class=n>HttpContext</span><span class=p>.</span><span class=n>Request</span><span class=p>.</span><span class=n>GetDisplayUrl</span><span class=p>());</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>,</span> <span class=n>context</span><span class=p>.</span><span class=n>ActionDescriptor</span><span class=p>.</span><span class=n>DisplayName</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>activity</span><span class=p>?.</span><span class=n>SetTag</span><span class=p>(</span><span class=n>DiagnosticNames</span><span class=p>.</span><span class=n>ObsoleteEndpoint</span><span class=p>,</span> <span class=kc>true</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This allows you to add all additional information your analysis will require.</p><div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900"><span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M506.3 417 293 53c-16.33-28-57.54-28-73.98.0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6c32.76.0 53.26-35 36.96-63zM232 168c0-13.25 10.75-24 24-24s24 10.8 24 24v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zm24 248c-17.36.0-31.44-14.08-31.44-31.44s14.07-31.44 31.44-31.44 31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z"/></svg>
</span></span><span class=dark:text-neutral-300>Please be aware that&rsquo;s quite easy to discose sensitive data in your APM of choice when adding for example the full URI, so beware of what tags you&rsquo;re adding to the span.</span></div><p>This is how the span will show in Aspire (<em>Please note the addition of the ObsoleteEndpoint and DisplayUrl values</em>):<figure><img class="my-0 rounded-md" loading=lazy srcset="/posts/obsolete-endpoints/images/traces-min_hu5d652d2081f38ecba854731794f34cc9_94770_330x0_resize_box_3.png 330w,
/posts/obsolete-endpoints/images/traces-min_hu5d652d2081f38ecba854731794f34cc9_94770_660x0_resize_box_3.png 660w,
/posts/obsolete-endpoints/images/traces-min_hu5d652d2081f38ecba854731794f34cc9_94770_1024x0_resize_box_3.png 1024w,
/posts/obsolete-endpoints/images/traces-min_hu5d652d2081f38ecba854731794f34cc9_94770_1320x0_resize_box_3.png 2x" src=/posts/obsolete-endpoints/images/traces-min_hu5d652d2081f38ecba854731794f34cc9_94770_660x0_resize_box_3.png alt="Obsolete trace"><figcaption>Obsolete trace</figcaption></figure></p><p>Aspire, as of now (June 2024) is mostly a development time tool that allows you to quickly coordinate and run a distributed application.</p><p>The Aspire Dashboard is a standalone service that <em>can</em> potentially be deployed in production but, as of now, it only provides in-memory storage of telemetry and there&rsquo;s no option to plug in a persistent storage mechanism.</p><p>In a production environment, you should probably rely on an industry-standard like <a href=https://prometheus.io/ target=_blank>Prometheus</a> & <a href=https://grafana.com/ target=_blank>Grafana</a> to collect and visualize your metrics.</p><h2 class="relative group">References<div id=references class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#references aria-label=Anchor>#</a></span></h2><ul><li><a href="https://www.youtube.com/watch?v=WzZI_IT6gYo&amp;ab_channel=NDCConferences" target=_blank>https://www.youtube.com/watch?v=WzZI_IT6gYo&amp;ab_channel=NDCConferences</a></li><li><a href=https://khalidabuhakmeh.com/global-endpoint-filters-with-aspnet-core-minimal-apis target=_blank>https://khalidabuhakmeh.com/global-endpoint-filters-with-aspnet-core-minimal-apis</a></li><li><a href=https://opentelemetry.io/docs/getting-started/dev/ target=_blank>https://opentelemetry.io/docs/getting-started/dev/</a></li><li><a href=https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview target=_blank>https://learn.microsoft.com/en-us/dotnet/aspire/get-started/aspire-overview</a></li></ul><h2 class="relative group">Conclusions<div id=conclusions class=anchor></div><span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100"><a class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" style=text-decoration-line:none!important href=#conclusions aria-label=Anchor>#</a></span></h2><p>In this post, we went through several steps, from implementing controller/endpoint filters to emitting custom telemetry, we looked at how the telemetry will be visualized in the Aspire Dashboard. Those custom telemetry will allow us to inspect which and how often our deprecated API are being used which in turn allows us to make an informed decision and minimize the risk of involuntarily breaking clients.</p><p>I hope you found this article helpful, that&rsquo;s all for today till the next time!</p></div><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?body=https://maxdon.tech/posts/obsolete-endpoints/&amp;subject=Telemetry-Driven%20API%20Evolution:%20Removing%20Obsolete%20Endpoints%20in%20ASP.NET%20Core" title="Send via email" aria-label="Send via email"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1-27.64 140.9 68.65 266.2 199.1 285.1 19.01 2.888 36.17-12.26 36.17-31.49l1e-4-.6631c0-15.74-11.44-28.88-26.84-31.24-84.35-12.98-149.2-86.13-149.2-174.2.0-102.9 88.61-185.5 193.4-175.4 91.54 8.869 158.6 91.25 158.6 183.2v16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98.0036c-7.299.0-13.2 4.992-15.12 11.68-24.85-12.15-54.24-16.38-86.06-5.106-38.75 13.73-68.12 48.91-73.72 89.64-9.483 69.01 43.81 128 110.9 128 26.44.0 50.43-9.544 69.59-24.88 24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3c0-149.2-133.9-265.632-287.3-235.57zM239.1 304.3c-26.47.0-48-21.56-48-48.05s21.53-48.05 48-48.05 48 21.56 48 48.05-20.6 48.05-48 48.05z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer/sharer.php?u=https://maxdon.tech/posts/obsolete-endpoints/&amp;quote=Telemetry-Driven%20API%20Evolution:%20Removing%20Obsolete%20Endpoints%20in%20ASP.NET%20Core" title="Share on Facebook" aria-label="Share on Facebook"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14.0 55.52 4.84 55.52 4.84v61h-31.28c-30.8.0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://maxdon.tech/posts/obsolete-endpoints/&amp;title=Telemetry-Driven%20API%20Evolution:%20Removing%20Obsolete%20Endpoints%20in%20ASP.NET%20Core" title="Share on LinkedIn" aria-label="Share on LinkedIn"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet/?url=https://maxdon.tech/posts/obsolete-endpoints/&amp;text=Telemetry-Driven%20API%20Evolution:%20Removing%20Obsolete%20Endpoints%20in%20ASP.NET%20Core" title="Tweet on Twitter" aria-label="Tweet on Twitter"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</span></a><a target=_blank class="m-1 rounded bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://bsky.app/intent/compose?text=Telemetry-Driven%20API%20Evolution:%20Removing%20Obsolete%20Endpoints%20in%20ASP.NET%20Core+https://maxdon.tech/posts/obsolete-endpoints/" title="Post on Bluesky" aria-label="Post on Bluesky"><span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M256 232.562c-21.183-41.196-78.868-117.97-132.503-155.834-51.378-36.272-70.978-29.987-83.828-24.181-14.872 6.72-17.577 29.554-17.577 42.988.0 13.433 7.365 110.138 12.169 126.281 15.873 53.336 72.376 71.358 124.413 65.574 2.66-.395 5.357-.759 8.089-1.097-2.68.429-5.379.796-8.089 1.097-76.259 11.294-143.984 39.085-55.158 137.972C201.224 526.527 237.424 403.67 256 341.379c18.576 62.291 39.972 180.718 150.734 83.983 83.174-83.983 22.851-126.674-53.408-137.969-2.71-.302-5.409-.667-8.089-1.096 2.732.337 5.429.702 8.089 1.096 52.037 5.785 108.54-12.239 124.413-65.574 4.804-16.142 12.169-112.847 12.169-126.281.0-13.434-2.705-36.267-17.577-42.988-12.85-5.806-32.45-12.09-83.829 24.181C334.868 114.595 277.183 191.366 256 232.562z"/></svg></span></a></section></div><script>var oid="views_posts/obsolete-endpoints/index.md",oid_likes="likes_posts/obsolete-endpoints/index.md"</script><script type=text/javascript src=/js/page.min.0860cf4e04fa2d72cc33ddba263083464d48f67de06114529043cb4623319efed4f484fd7f1730df5abea0e2da6f3538855634081d02f2d6e920b956f063e823.js integrity="sha512-CGDPTgT6LXLMM926JjCDRk1I9n3gYRRSkEPLRiMxnv7U9IT9fxcw31q+oOLabzU4hVY0CB0C8tbpILlW8GPoIw=="></script></section><footer class="pt-8 max-w-prose print:hidden"><div class=pt-8><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex justify-between pt-3"><span><a class="flex group mr-3" href=/posts/ms-graph-permissions-ids/><span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&larr;</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Microsoft Graph Permissions Well-Known Ids</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2023-02-09 17:51:31 +0100 +0100">9 February 2023</time>
</span></span></a></span><span><a class="flex text-right group ml-3" href=/posts/k3s-raspberry-pi/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Install k3s on a Raspberry PI</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400"><time datetime="2024-07-01 18:55:40 +0200 +0200">1 July 2024</time>
</span></span><span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">&rarr;</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">&larr;</span></a></span></div></div><div class=pt-3><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class=pt-3><script src=https://giscus.app/client.js data-repo=ilmax/ilmax.github.io data-repo-id=R_kgDOI1C2VQ data-category=Comments data-category-id=DIC_kwDOI1C2Vc4CTw93 data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=cobalt data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></div></footer></article><div id=top-scroller class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0"><a href=#the-top class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" aria-label="Scroll to top" title="Scroll to top">&uarr;</a></div></main><footer id=site-footer class="py-10 print:hidden"><nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400"><ul class="flex flex-col list-none sm:flex-row"><li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0"><a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2 flex items-center" href title></a></li></ul></nav><div class="flex items-center justify-between"><p class="text-sm text-neutral-500 dark:text-neutral-400">&copy;
2024
Massimiliano Donini</p><p class="text-xs text-neutral-500 dark:text-neutral-400">Powered by <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://gohugo.io/ target=_blank rel="noopener noreferrer">Hugo</a> & <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href=https://blowfish.page/ target=_blank rel="noopener noreferrer">Blowfish</a></p></div><script>mediumZoom(document.querySelectorAll("img:not(.nozoom)"),{margin:24,background:"rgba(0,0,0,0.5)",scrollOffset:0})</script><script type=text/javascript src=/js/process.min.ee03488f19c93c2efb199e2e3014ea5f3cb2ce7d45154adb3399a158cac27ca52831db249ede5bb602700ef87eb02434139de0858af1818ab0fb4182472204a4.js integrity="sha512-7gNIjxnJPC77GZ4uMBTqXzyyzn1FFUrbM5mhWMrCfKUoMdsknt5btgJwDvh+sCQ0E53ghYrxgYqw+0GCRyIEpA=="></script></footer><div id=search-wrapper class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url=https://maxdon.tech/ style=z-index:500><div id=search-modal class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800"><header class="relative z-10 flex items-center justify-between flex-none px-2"><form class="flex items-center flex-auto min-w-0"><div class="flex items-center justify-center w-8 h-8 text-neutral-400"><span class="relative block icon"><svg aria-hidden="true" focusable="false" data-prefix="fas" data-icon="search" class="svg-inline--fa fa-search fa-w-16" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path fill="currentcolor" d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></span></div><input type=search id=search-query class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" placeholder=Search tabindex=0></form><button id=close-search-button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" title="Close (Esc)">
<span class="relative block icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path fill="currentcolor" d="M310.6 361.4c12.5 12.5 12.5 32.75.0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3 54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75.0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75.0-45.25s32.75-12.5 45.25.0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25.0s12.5 32.75.0 45.25l-105.4 105.4L310.6 361.4z"/></svg></span></button></header><section class="flex-auto px-2 overflow-auto"><ul id=search-results></ul></section></div></div></div></body></html>