<!doctype html><html lang=en-us><head><title>Terraform Tips & Tricks: Managing Large-Scale Azure Resource Imports // Massimiliano's Tech Chronicles</title><link rel="shortcut icon" href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Massimiliano Donini"><meta name=description content><link rel=stylesheet href=/css/main.min.cdda4555892afe80e149565d48e4ff09319ebdbd7b121ad7910661daac049b82.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-QK96EXLDNF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-QK96EXLDNF",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Terraform Tips & Tricks: Managing Large-Scale Azure Resource Imports"><meta name=twitter:description content="This post describes my journey to import several hundred Azure resources in Terraform. Before digging into the what and the how let me give you a brief description of our environment&rsquo;s infrastructure.
In my current company, we manage many Azure resources for each environment and we have a few of them (DEV, TEST, etc.). Every environment looks pretty much the same and it mostly differs by product SKUs, database sizes, etc."><meta property="og:title" content="Terraform Tips & Tricks: Managing Large-Scale Azure Resource Imports"><meta property="og:description" content="This post describes my journey to import several hundred Azure resources in Terraform. Before digging into the what and the how let me give you a brief description of our environment&rsquo;s infrastructure.
In my current company, we manage many Azure resources for each environment and we have a few of them (DEV, TEST, etc.). Every environment looks pretty much the same and it mostly differs by product SKUs, database sizes, etc."><meta property="og:type" content="article"><meta property="og:url" content="https://maxdon.tech/posts/import-many-terraform/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-08T14:44:21+00:00"><meta property="article:modified_time" content="2023-01-08T14:44:21+00:00"></head><body><header class=app-header><a href=https://maxdon.tech><img class=app-header-avatar src=/avatar.jpg alt="Massimiliano Donini"></a>
<span class=app-header-title>Massimiliano's Tech Chronicles</span><p>My adventures in Tech</p><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
|
<a class=app-header-menu-item href=/about/>About</a>
|
<a class=app-header-menu-item href=/tags/>Tags</a></nav><div class=app-header-social><a href=https://github.com/ilmax target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/maxx_don target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://www.linkedin.com/in/massimiliano-donini/ target=_blank rel="noreferrer noopener me"><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin"><title>LinkedIn</title><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Terraform Tips & Tricks: Managing Large-Scale Azure Resource Imports</h1><div class=post-meta><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 8, 2023</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>9 min read</div><div><svg viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=https://maxdon.tech/tags/azure/>azure</a>
<a class=tag href=https://maxdon.tech/tags/terraform/>terraform</a>
<a class=tag href=https://maxdon.tech/tags/devops/>devops</a></div></div></header><div class=post-content><p>This post describes my journey to import several hundred Azure resources in Terraform. Before digging into the what and the how let me give you a brief description of our environment&rsquo;s infrastructure.</p><p>In my current company, we manage many Azure resources for each environment and we have a few of them (DEV, TEST, etc.). Every environment looks pretty much the same and it mostly differs by product SKUs, database sizes, etc.</p><p>My fellow team members and I are building a microservices solution, we have around 50 independent services deployed in Azure that require some specific resources (imagine a SQL database or a Storage container), and on top of that, we have all the service agnostic infrastructure.</p><p>All these resources aren&rsquo;t created/updated in the same way, some use ARM templates, some use PowerShell scripts, some use Azure cli scripts and so on.
This is mostly because we need to work around some tooling limitations e.g. you can&rsquo;t create resources in Azure Active Directory using ARM templates.</p><p>All the aforementioned scripts are placed in a shared repository and every project references what it needs in its deployment pipeline.</p><p>This approach works, but it has several problems:</p><ol><li>We use different technologies to deploy infrastructure and that makes it harder for newcomers to get up to speed quickly</li><li>Deployments take longer than necessary</li><li>It&rsquo;s impossible to have a preview of the changes that are going to be applied at deployment time</li><li>Re-deploying infrastructure may not fix all the <a href="https://wiki.gccollab.ca/index.php?title=Technology_Trends/Infrastructure_as_Code&mobileaction=toggle_view_desktop#Configuration_Drift">configuration drift</a> especially the PowerShell/az cli scripts</li></ol><p>I&rsquo;m sure I missed several other points but these are the most painful ones.</p><p>Hence we decided to move to Terraform since it can address all the points above and, according to <a href=https://octoverse.github.com/2022/top-programming-languages>GitHub Octoverse 2022</a>, HCL was the fastest growing language in 2021-2022.</p><h2 id=the-import-challenge>The import challenge</h2><p>If you start on a greenfield project everything is quite easy, but as you may know, if a resource has been created outside Terraform, it needs to be imported to be managed with Terraform in the future.
Importing resources is not difficult, on the provider documentation site, at the bottom of the page of every resource, you can find the command to execute to import a given resource.</p><p>My problem was that I had hundreds of them, around 160 global resources, multiplied by all the various environments + between 5-10 resource service dependent multiplied by the number of services ~50 multiplied by the number of environments.</p><p>As you can imagine this adds up very quickly, especially because importing resources is a tedious task.
To import a resource in Terraform you need a couple of things:</p><ul><li>Create the resource in your configuration files</li><li>The Terraform resource id</li><li>The Azure resource id</li></ul><p>For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>                |--------------Terraform resource id-------------------| |-----------------------------------------Azure resource id---------------------------------------------------------------|
</span></span><span style=display:flex><span>terraform import module.servicebus.azurerm_servicebus_namespace.example  /subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/mygroup1/providers/Microsoft.ServiceBus/namespaces/sbns1
</span></span></code></pre></div><p>To get the Terraform resource id, you may first need to come up with the final module structure because if you use modules, the module name would be part of the Terraform resource id (as can be seen above).</p><p>Figuring out the Azure resource id can also be challenging for some nested resources, e.g. a cosmos role assignment requires some az cli gymnastics.</p><p>This seemed like a herculean effort so I started looking around hoping to find a tool that could help with a bulk import.</p><h3 id=azure-terrafy---aztfy>Azure Terrafy - Aztfy</h3><p><a href=https://github.com/Azure/aztfy>Aztfy</a> is a tool developed by Microsoft that allows you to bulk import resources, it has some configuration so you can specify what to import, the names to import and so on.
After spending some time with the tool, I quickly realized it may be a no-go. The problem I had with this tool is twofold:</p><ol><li>It doesn&rsquo;t generate reproducible Terraform configurations</li><li>It doesn&rsquo;t generate Terraform idiomatic code</li></ol><p>Let me expand on those:</p><p>Not generating reproducible configurations means that after an import, when you run Terraform plan, you may still have changes that you need to fix manually, or worse, Terraform may fail due to validation problems.
This limitation is documented in the project <a href=https://github.com/Azure/aztfy#limitation>README</a> and I could&rsquo;ve lived with it.</p><p>Not generating idiomatic code is a bit more problematic, since it requires manually changing most parts of the imported code to make use of variables or to reference a parent resource.
This means that all the code that <strong>aztfy</strong> will output, needs to be adjusted/modified. Moreover, if you decide to reorganize the code and move resources in a different module (hence changing the Terraform resource id) after it has been imported, then you have to either start modifying the Terraform state manually, or you may need to import it all over again.</p><p>Given the above downsides, I decided to use it only marginally and instead start writing my configuration from scratch.</p><h2 id=my-approach>My approach</h2><p>Before starting I came up with a set of principles to use as guidelines when writing HCL modules, which are:</p><ol><li>One module for every different resource type used</li><li>For every module that needs access to resources defined in other modules, read these resources with a data source</li><li>All the module&rsquo;s inputs are defined in a file called <code>variables.tf</code></li><li>All the permissions-related stuff (RBAC, AAD group membership) will go in a file called <code>permission.tf</code></li><li>All the networking configuration (Firewall rules, VNet, Private endpoints and so on) will go in a file called <code>networking.tf</code></li><li>All the module&rsquo;s outputs will go in a file called <code>output.tf</code></li><li>These lower-level modules will be invoked by a higher-level module where most of the naming logic will be</li><li>Lower-level modules can only be called by higher-level modules</li><li>Several higher-level modules will be created:<ul><li>Environment specific with all the global resources</li><li>Several service-specific ones, one for each type of service</li></ul></li><li>Client code can only reference higher-level modules</li><li>Higher level modules should have the least number of secret possible</li><li>Lower-level modules shouldn&rsquo;t reference other lower-level modules</li></ol><blockquote><p>Please note that these are principles I came up with and that make sense in my specific scenario, your mileage may vary</p></blockquote><h3 id=directory-structure>Directory structure</h3><p>The principles stated above helped me come up with a directory structure that looks like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>├── environments
</span></span><span style=display:flex><span>│   ├── acc
</span></span><span style=display:flex><span>│   ├── dev
</span></span><span style=display:flex><span>│   ├── prod
</span></span><span style=display:flex><span>│   └── tst
</span></span><span style=display:flex><span>├── modules
</span></span><span style=display:flex><span>│   ├── private                --&gt; Lower-level modules
</span></span><span style=display:flex><span>│   │   ├── global
</span></span><span style=display:flex><span>│   │   │   ├── global_azure_service_1          e.g. Cosmos Db 
</span></span><span style=display:flex><span>│   │   │   ├── global_azure_service_2          e.g. vNET
</span></span><span style=display:flex><span>│   │   │   ├── global_azure_service_3          e.g. App Service Plan
</span></span><span style=display:flex><span>│   │   └── service
</span></span><span style=display:flex><span>│   │       ├── service_specific_resource_1     e.g. App service
</span></span><span style=display:flex><span>│   │       ├── service_specific_resource_2     e.g. Cosmos container
</span></span><span style=display:flex><span>│   │       ├── service_specific_resource_3     e.g. Sql Database
</span></span><span style=display:flex><span>│   └── public                 --&gt; Higher-level modules
</span></span><span style=display:flex><span>│       ├── environment     
</span></span><span style=display:flex><span>│       └── webapp
</span></span></code></pre></div><h3 id=import-script>Import Script</h3><p>After coming up with this list of principles, I started creating the Terraform module for each resource type, importing it in a local state, running Terraform plan to ensure there are no changes and repeating till I created all the modules.</p><p>To make the plan/import phase quick, I was applying the changes on a single lower-level module basis.</p><p>Since I ended up importing the resources over and over and over again, I decided to write a small PowerShell script to help me speed up the process.</p><p>This script tries to address the two main paint points:</p><ul><li>Do not re-import a resource that&rsquo;s already imported</li><li>Simplify reuse across environments via PowerShell string interpolation, whenever Azure resource Ids are predictable.</li></ul><blockquote><p>Please note that the last point depends on your resources naming conventions.</p></blockquote><p>The script looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>Terraform init // Comment this out after the first execution
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Get all the items from Terraform state and put it inside an array</span>
</span></span><span style=display:flex><span>$stateItems = $(Terraform state list)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> ImportIfNotExists {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>param</span> (
</span></span><span style=display:flex><span>        [<span style=color:#66d9ef>String</span>]$resourceName,
</span></span><span style=display:flex><span>        [<span style=color:#66d9ef>String</span>]$resourceId
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($resourceId <span style=color:#f92672>-eq</span> $null <span style=color:#f92672>-or</span> $resourceId <span style=color:#f92672>-eq</span> <span style=color:#e6db74>&#34;&#34;</span>) {
</span></span><span style=display:flex><span>        Write-Warning <span style=color:#e6db74>&#34;Resource id for </span>$resourceName<span style=color:#e6db74> is null&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> ($stateItems <span style=color:#f92672>-notcontains</span> $resourceName.Replace(<span style=color:#e6db74>&#34;\&#34;</span>, <span style=color:#e6db74>&#34;&#34;</span>)) {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;Importing </span>$resourceName<span style=color:#e6db74> with id </span>$resourceId<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        Terraform import <span style=color:#e6db74>&#34;</span>$resourceName<span style=color:#e6db74>&#34;</span> <span style=color:#e6db74>&#34;</span>$resourceId<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> ($LASTEXITCODE <span style=color:#f92672>-ne</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>            Write-Warning <span style=color:#e6db74>&#34;Error importing </span>$resourceName<span style=color:#e6db74> with id </span>$resourceId<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            Write-Host <span style=color:#e6db74>&#34;</span>$resourceName<span style=color:#e6db74> imported&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        Write-Host <span style=color:#e6db74>&#34;</span>$resourceName<span style=color:#e6db74> already exists&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$env = <span style=color:#e6db74>&#34;DEV&#34;</span>
</span></span><span style=display:flex><span>$subscriptionId = <span style=color:#e6db74>&#34;your-subscription-id-here&#34;</span>
</span></span><span style=display:flex><span>$spokeResourceGroupName = <span style=color:#e6db74>&#34;myrg-spoke-</span>$env<span style=color:#e6db74>&#34;</span>.ToLower()
</span></span><span style=display:flex><span>$hubResourceGroupName = <span style=color:#e6db74>&#34;myrg-hub-</span>$env<span style=color:#e6db74>&#34;</span>.ToLower()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ErrorActionPreference  = <span style=color:#e6db74>&#34;Stop&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>## Resource group import</span>
</span></span><span style=display:flex><span>ImportIfNotExists <span style=color:#e6db74>&#39;module.environment.azurerm_resource_group.spoke_rg&#39;</span> <span style=color:#e6db74>&#34;/subscriptions/</span>$subscriptionId<span style=color:#e6db74>/resourceGroups/</span>$spokeResourceGroupName<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>ImportIfNotExists <span style=color:#e6db74>&#39;module.environment.azurerm_resource_group.hub_rg&#39;</span> <span style=color:#e6db74>&#34;/subscriptions/</span>$subscriptionId<span style=color:#e6db74>/resourceGroups/</span>$hubResourceGroupName<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>This script allows me to quickly import resources and iterate faster since it allows me to re-run the same over and over without worrying about re-importing a resource that&rsquo;s already part of the state.</p><p>As stated above, you can make the script reusable for multiple environments with few modifications. Some Azure resource ids are a bit more complex to figure out hence I usually do a manual lookup and find-and-replace.
Some of those resources include:</p><ul><li>Cosmos Sql Role Definition (The Role id uses a guid so it&rsquo;s different for every role definition)</li><li>Cosmos Sql Role Assignment (same as above)</li><li>RBAC role assignment</li><li>Automation account job schedules</li><li>AAD Groups</li><li>AAD Groups membership</li></ul><blockquote><p>Please note that your mileage may vary depending on the resources you use</p></blockquote><p>If you want to, you can enhance the script to also look up these resources using the azure cli and a bit of <a href="https://learn.microsoft.com/en-us/cli/azure/query-azure-cli?tabs=concepts,bash">JMESPath</a>, for example, I&rsquo;m doing this to look up AAD groups since in my case they follow a naming convention:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>ImportIfNotExists <span style=color:#e6db74>&#39;sample.azuread_group.your_group_name&#39;</span> $(az ad group show --group <span style=color:#e6db74>&#34;{your-group-name-prefix}-</span>$env<span style=color:#e6db74>&#34;</span> --query id --output tsv)
</span></span></code></pre></div><p>Here below you can see an example where I&rsquo;m employing JMESPath to further filter the result of az cli to look up the role assignment for a given role and group:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>ImportIfNotExists <span style=color:#e6db74>&#39;sample.azurerm_role_assignment.your_group_assingments&#39;</span> $(az role assignment list --scope {your-scope} --query <span style=color:#e6db74>&#34;[?principalName==&#39;{you-principal-name}&#39; &amp;&amp; roleDefinitionName==&#39;{your-role-name}&#39;].id&#34;</span> -o tsv)
</span></span></code></pre></div><p>where:</p><ul><li><strong>{your-scope}</strong> is the resource you assigned the RBAC role assignment to (e.g. the resource group or a specific resource)</li><li><strong>{you-principal-name}</strong> is the user name, group name or managed identity name of the principal that will be granted the role</li><li><strong>{your-role-name}</strong> is the name of the RBAC roles you assigned (e.g. Contributor)</li></ul><p>This is quite powerful and allows you to make the script parametric enough to allow you to reuse it for all environments.</p><blockquote><p>It&rsquo;s also worth considering though that the import operation will be executed just once, so it may be quick to just do a find replace at times.</p></blockquote><h2 id=quirks>Quirks</h2><p>If you have declared resources that use <code>for_each</code> in HCL, the name of the resource may contain (based on what you&rsquo;re foreach-ing) a string, e.g.
imagine you&rsquo;re creating several service bus topic using a for_each in the following way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_servicebus_namespace&#34; &#34;example&#34;</span> {
</span></span><span style=display:flex><span>  name                <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tfex-servicebus-namespace&#34;</span>
</span></span><span style=display:flex><span>  location            <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>example</span>.<span style=color:#66d9ef>location</span>
</span></span><span style=display:flex><span>  resource_group_name <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_resource_group</span>.<span style=color:#66d9ef>example</span>.<span style=color:#66d9ef>name</span>
</span></span><span style=display:flex><span>  sku                 <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Standard&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;azurerm_servicebus_topic&#34; &#34;topics&#34;</span> {
</span></span><span style=display:flex><span>  name         <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>
</span></span><span style=display:flex><span>  namespace_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>azurerm_servicebus_namespace</span>.<span style=color:#66d9ef>example</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>for_each</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>topics</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Then the Terraform identifier will be something like the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>module</span>.<span style=color:#a6e22e>servicebus</span>.<span style=color:#a6e22e>azurerm_servicebus_topic</span>.<span style=color:#a6e22e>topics</span>[<span style=color:#e6db74>&#34;{topic-name}&#34;</span>].
</span></span></code></pre></div><p>To make Terraform and PowerShell play nicely together in the import script, you have to write the above this way:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ps1 data-lang=ps1><span style=display:flex><span>ImportIfNotExists <span style=color:#e6db74>&#39;module.servicebus.azurerm_servicebus_topic.topics[\&#34;{topic-name}\&#34;]&#39;</span> <span style=color:#e6db74>&#34;{servicebus-resource-id}&#34;</span>
</span></span></code></pre></div><p>To avoid the Terraform error: import requires you to specify two arguments.</p><h2 id=useful-resources>Useful resources</h2><p>To import a resource you need to find its unique identifier in Azure and this is not always easily doable from the portal so I took advantage of the following tools to make my life simpler</p><ul><li><a href=https://learn.microsoft.com/en-us/cli/azure/install-azure-cli>az cli</a></li><li><a href=resource.azure.com>resources.azure.com</a></li></ul><p>The first one will be familiar to everyone, it&rsquo;s the azure command line tool and it&rsquo;s a must-have, the second one is a bit less known in my opinion but still an excellent resource to look into the definition of the various resources.</p><p>This work took quite a bit of time but in the end, I was able to import all the resources in all the environments and come up with idiomatic HCL code.</p><p>I hope you find this helpful!</p><p>Till the next time.</p></div><div class=post-footer><style>.resp-sharing-button__link,.resp-sharing-button__icon{display:inline-block}.resp-sharing-button__link{text-decoration:none;color:#fff!important;margin:.2em}.resp-sharing-button{border-radius:5px;transition:25ms ease-out;padding:.5em .75em;font-family:Helvetica Neue,Helvetica,Arial,sans-serif}.resp-sharing-button__icon svg{width:1em;height:1em;margin-right:.4em;vertical-align:middle}.resp-sharing-button--small svg{margin:0;vertical-align:middle}.resp-sharing-button__icon{stroke:#fff;fill:none}.resp-sharing-button__icon--solid,.resp-sharing-button__icon--solidcircle{fill:#fff;stroke:none}.resp-sharing-button--twitter{background-color:#55acee}.resp-sharing-button--twitter:hover{background-color:#2795e9}.resp-sharing-button--pinterest{background-color:#bd081c}.resp-sharing-button--pinterest:hover{background-color:#8c0615}.resp-sharing-button--facebook{background-color:#3b5998}.resp-sharing-button--facebook:hover{background-color:#2d4373}.resp-sharing-button--tumblr{background-color:#35465c}.resp-sharing-button--tumblr:hover{background-color:#222d3c}.resp-sharing-button--reddit{background-color:#ff4500}.resp-sharing-button--reddit:hover{background-color:#3a80c1}.resp-sharing-button--google{background-color:#dd4b39}.resp-sharing-button--google:hover{background-color:#c23321}.resp-sharing-button--linkedin{background-color:#0077b5}.resp-sharing-button--linkedin:hover{background-color:#046293}.resp-sharing-button--email{background-color:#777}.resp-sharing-button--email:hover{background-color:#5e5e5e}.resp-sharing-button--xing{background-color:#1a7576}.resp-sharing-button--xing:hover{background-color:#114c4c}.resp-sharing-button--whatsapp{background-color:#25d366}.resp-sharing-button--whatsapp:hover{background-color:#1da851}.resp-sharing-button--hackernews{background-color:#f60}.resp-sharing-button--hackernews:hover,.resp-sharing-button--hackernews:focus{background-color:#fb6200}.resp-sharing-button--vk{background-color:#507299}.resp-sharing-button--vk:hover{background-color:#43648c}.resp-sharing-button--facebook{background-color:#3b5998;border-color:#3b5998}.resp-sharing-button--facebook:hover,.resp-sharing-button--facebook:active{background-color:#2d4373;border-color:#2d4373}.resp-sharing-button--twitter{background-color:#55acee;border-color:#55acee}.resp-sharing-button--twitter:hover,.resp-sharing-button--twitter:active{background-color:#2795e9;border-color:#2795e9}.resp-sharing-button--tumblr{background-color:#35465c;border-color:#35465c}.resp-sharing-button--tumblr:hover,.resp-sharing-button--tumblr:active{background-color:#222d3c;border-color:#222d3c}.resp-sharing-button--email{background-color:#777;border-color:#777}.resp-sharing-button--email:hover,.resp-sharing-button--email:active{background-color:#5e5e5e;border-color:#5e5e5e}.resp-sharing-button--pinterest{background-color:#bd081c;border-color:#bd081c}.resp-sharing-button--pinterest:hover,.resp-sharing-button--pinterest:active{background-color:#8c0615;border-color:#8c0615}.resp-sharing-button--linkedin{background-color:#0077b5;border-color:#0077b5}.resp-sharing-button--linkedin:hover,.resp-sharing-button--linkedin:active{background-color:#046293;border-color:#046293}.resp-sharing-button--reddit{background-color:#ff4500;border-color:#ff4500}.resp-sharing-button--reddit:hover,.resp-sharing-button--reddit:active{background-color:#ff5700;border-color:#ff5700}.resp-sharing-button--xing{background-color:#1a7576;border-color:#1a7576}.resp-sharing-button--xing:hover .resp-sharing-button--xing:active{background-color:#114c4c;border-color:#114c4c}.resp-sharing-button--whatsapp{background-color:#25d366;border-color:#25d366}.resp-sharing-button--whatsapp:hover,.resp-sharing-button--whatsapp:active{background-color:#1da851;border-color:#1da851}.resp-sharing-button--hackernews{background-color:#f60;border-color:#f60}.resp-sharing-button--hackernews:hover .resp-sharing-button--hackernews:active{background-color:#fb6200;border-color:#fb6200}.resp-sharing-button--vk{background-color:#507299;border-color:#507299}.resp-sharing-button--vk:hover .resp-sharing-button--vk:active{background-color:#43648c;border-color:#43648c}.resp-sharing-button--telegram{background-color:#54a9eb}.resp-sharing-button--telegram:hover{background-color:#4b97d1}</style><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https://maxdon.tech/posts/import-many-terraform/" target=_blank rel=noopener aria-label title=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=Terraform%20Tips%20%26%20Tricks%3a%20Managing%20Large-Scale%20Azure%20Resource%20Imports&url=https://maxdon.tech/posts/import-many-terraform/" target=_blank rel=noopener aria-label title=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5.0-4.55 2.04-4.55 4.54.0.36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3.0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35.0 12.92-6.92 12.92-12.93.0-.2.0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z"/></svg></div></div></a><a class=resp-sharing-button__link href="mailto:?subject=Terraform%20Tips%20%26%20Tricks%3a%20Managing%20Large-Scale%20Azure%20Resource%20Imports&body=https://maxdon.tech/posts/import-many-terraform/" target=_self rel=noopener aria-label title=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 4H2C.9 4 0 4.9.0 6v12c0 1.1.9 2 2 2h20c1.1.0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17.0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1.0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08.0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z"/></svg></div></div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https://maxdon.tech/posts/import-many-terraform/&resubmit=true&title=Terraform%20Tips%20%26%20Tricks%3a%20Managing%20Large-Scale%20Azure%20Resource%20Imports" target=_blank rel=noopener aria-label title=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--solid"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M24 11.5c0-1.65-1.35-3-3-3-.96.0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65.0 3-1.35 3-3s-1.35-3-3-3c-1.38.0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65.0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66.0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64.0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4.0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6.0.23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1.0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1.0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z"/></svg></div></div></a><script src=https://giscus.app/client.js data-repo=ilmax/ilmax.github.io data-repo-id=R_kgDOI1C2VQ data-category=Comments data-category-id=DIC_kwDOI1C2Vc4CTw93 data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=dark_dimmed data-lang=en data-loading=lazy crossorigin=anonymous async></script></div></article></main></body><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></html>